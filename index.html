<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anonymous Emotional Support Rooms | Friends&Me</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Friends&Me is an anonymous emotional support community with themed rooms like Daily Thoughts, Confessions, Dark Thoughts, Love and more. Share what‚Äôs on your mind freely, get support, and see you‚Äôre not alone ‚Äî no accounts, no judgment.">
    <meta name="keywords" content="anonymous, emotional support, mental health, community, share feelings, safe space, no judgment, confessions">
    <meta name="author" content="Friends&Me">
    <meta name="robots" content="index, follow">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://friendsnme.net/">
    <meta property="og:title" content="Friends&Me - Anonymous Emotional Support">
    <meta property="og:description" content="A safe, anonymous space to share your thoughts and feelings. No accounts, no judgment.">
    <meta property="og:image" content="https://friendsnme.net/og-image.png">
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://friendsnme.net/">
    <meta name="twitter:title" content="Friends&Me - Anonymous Emotional Support">
    <meta name="twitter:description" content="A safe, anonymous space to share your thoughts and feelings. No accounts, no judgment.">
    <meta name="twitter:image" content="https://friendsnme.net/og-image.png">
    
        <!-- Structured Data for SEO -->
        <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "WebSite",
            "name": "Friends&Me",
            "url": "https://friendsnme.net/",
            "description": "Anonymous emotional support community with themed rooms to share thoughts and feelings."
        }
        </script>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üí≠</text></svg>">
    
    <!-- v1.2 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .main-layout {
            display: flex;
            flex-direction: row;
            max-width: 1200px;
            margin: 0 auto;
            min-height: 80vh;
        }

        .sidebar {
            width: 260px;
            background: #192734;
            border-right: 1px solid #38444d;
            padding: 24px 16px 24px 16px;
            display: flex;
            flex-direction: column;
            gap: 32px;
            position: sticky;
            top: 0;
            align-self: flex-start;
            height: 100vh;
            min-height: 100vh;
        }

        .sidebar-section h3 {
            color: #1da1f2;
            font-size: 1.05rem;
            margin-bottom: 8px;
        }

        .sidebar-section ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar-section ul li {
            margin-bottom: 8px;
            color: #e7e9ea;
            font-size: 0.97rem;
        }

        .sidebar-section p {
            color: #8899a6;
            font-size: 0.95rem;
        }

        .main-feed {
            flex: 1;
            padding: 32px 24px 24px 24px;
            min-width: 0;
        }

        #latestPostContainer {
            margin: 0 auto;
            max-width: 520px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #15202b;
            color: #e7e9ea;
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            position: relative;
            text-align: center;
            padding: 25px 0;
            margin-bottom: 20px;
        }

        h1 {
            font-size: 1.6rem;
            font-weight: 700;
            color: #e7e9ea;
        }

        h1 span {
            color: #1da1f2;
        }

        #mobileMenuBtn {
            display: none;
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
        }

        .categories {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 14px;
            justify-content: center;
            max-width: 100%;
            margin: 0 auto;
        }

        .category-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 32px 16px;
            background: #192734;
            border: 1px solid #38444d;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            min-height: 200px;
            aspect-ratio: 1 / 1.1;
        }

        .category-card:hover {
            background: #22303c;
            border-color: #1da1f2;
            transform: translateY(-3px);
        }

        .category-visual {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 42px;
            filter: grayscale(1) contrast(0.8);
            opacity: 0.7;
            transition: all 0.2s ease;
        }

        @media (max-width: 700px) {
            #sidebarNav {
                display: none !important;
            }

            #mobileMenuBtn {
                display: block !important;
            }

            .plus-btn {
                top: unset !important;
                bottom: 18px !important;
                right: 18px !important;
                width: 56px !important;
                height: 56px !important;
                font-size: 2.1rem !important;
                box-shadow: 0 6px 16px rgba(29, 161, 242, 0.4) !important;
            }

            header {
                margin-bottom: 10px;
            }

            h1 {
                font-size: 1.2rem;
            }
        }

        .category-card:hover .category-visual {
            filter: grayscale(0);
            opacity: 1;
        }

        .category-name {
            font-size: 1rem;
            font-weight: 600;
            color: #e7e9ea;
            margin-bottom: 8px;
        }

        .category-desc {
            font-size: 0.78rem;
            color: #8899a6;
            line-height: 1.4;
        }

        .room-title {
            text-align: center;
            font-size: 1.2rem;
            color: #1da1f2;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .compose {
            margin-bottom: 20px;
            background: #192734;
            border: 1px solid #38444d;
            border-radius: 16px;
            padding: 16px;
        }

        .compose textarea {
            width: 100%;
            background: transparent;
            border: none;
            color: #e7e9ea;
            font-size: 1rem;
            resize: none;
            height: 80px;
            font-family: inherit;
        }

        .compose textarea:focus {
            outline: none;
        }

        .compose textarea::placeholder {
            color: #8899a6;
        }

        .compose-actions {
            display: flex;
            justify-content: flex-end;
            border-top: 1px solid #38444d;
            padding-top: 12px;
            margin-top: 12px;
        }

        .post-btn {
            padding: 10px 20px;
            background: #1da1f2;
            border: none;
            border-radius: 9999px;
            color: #fff;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: background 0.2s;
        }

        .post-btn:hover {
            background: #1a91da;
        }

        .post-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .posts {
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .post {
            background: #192734;
            border: 1px solid #38444d;
            padding: 16px;
            cursor: pointer;
            transition: background 0.15s;
        }

        .post:hover {
            background: #1c2e3d;
        }

        .post:first-child {
            border-radius: 12px 12px 0 0;
        }

        .post:last-child {
            border-radius: 0 0 12px 12px;
        }

        .post:only-child {
            border-radius: 12px;
        }

        .post + .post {
            border-top: none;
        }

        .post-headline {
            font-size: 1rem;
            font-weight: 700;
            color: #e7e9ea;
            margin-bottom: 6px;
            line-height: 1.3;
        }

        .post-content {
            font-size: 0.95rem;
            line-height: 1.5;
            color: #e7e9ea;
            margin-bottom: 12px;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .post-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 8px;
        }

        .post-time {
            font-size: 0.8rem;
            color: #8899a6;
        }

        .relate-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: transparent;
            border: none;
            border-radius: 9999px;
            color: #8899a6;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .relate-btn:hover {
            background: rgba(29, 161, 242, 0.1);
            color: #1da1f2;
        }

        .relate-btn.related {
            color: #f91880;
        }

        .relate-btn.related:hover {
            background: rgba(249, 24, 128, 0.1);
        }

        .relate-btn .heart {
            font-size: 1.1rem;
            transition: transform 0.2s;
        }

        .relate-btn.related .heart {
            transform: scale(1.1);
        }

        .relate-count {
            font-weight: 600;
            min-width: 20px;
        }

        /* Comments */
        .post-comments-bar {
            margin-top: 8px;
            display: flex;
            justify-content: flex-start;
        }

        .comment-toggle {
            background: none;
            border: none;
            color: #8899a6;
            font-size: 0.85rem;
            cursor: pointer;
            padding: 4px 0;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .comment-toggle:hover {
            color: #1da1f2;
        }

        .comments-section {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #38444d;
        }

        .comments-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 8px;
        }

        .comment-item {
            background: #15202b;
            border-radius: 10px;
            padding: 8px 10px;
        }

        .comment-content {
            font-size: 0.9rem;
            color: #e7e9ea;
            margin-bottom: 4px;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .comment-meta {
            font-size: 0.75rem;
            color: #8899a6;
        }

        .comment-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 4px;
        }

        .comment-like-btn {
            background: none;
            border: none;
            color: #8899a6;
            font-size: 0.8rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 4px;
            border-radius: 9999px;
        }

        .comment-like-btn:hover {
            background: rgba(29, 161, 242, 0.12);
            color: #1da1f2;
        }

        .comment-like-btn.liked {
            color: #f91880;
        }

        .comment-empty {
            font-size: 0.85rem;
            color: #8899a6;
        }

        .comment-form {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .comment-input {
            width: 100%;
            background: #15202b;
            border: 1px solid #38444d;
            border-radius: 8px;
            padding: 8px 10px;
            color: #e7e9ea;
            font-size: 0.9rem;
            font-family: inherit;
            resize: none;
            min-height: 50px;
        }

        .comment-input::placeholder {
            color: #8899a6;
        }

        .comment-submit {
            align-self: flex-end;
            padding: 6px 14px;
            background: #1da1f2;
            border: none;
            border-radius: 9999px;
            color: #fff;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
        }

        .comment-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: #8899a6;
            background: #192734;
            border: 1px solid #38444d;
            border-radius: 16px;
        }

        .empty-state p {
            font-size: 0.95rem;
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #1da1f2;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            margin-bottom: 16px;
            padding: 8px 0;
            transition: opacity 0.2s;
        }

        .back-btn:hover {
            opacity: 0.8;
        }

        .plus-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 48px;
            height: 48px;
            background: #1da1f2;
            border: none;
            border-radius: 50%;
            color: #fff;
            font-size: 28px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(29, 161, 242, 0.3);
        }

        .plus-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(29, 161, 242, 0.4);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 200;
            padding: 20px;
        }

        .modal {
            background: #192734;
            border: 1px solid #38444d;
            border-radius: 16px;
            width: 100%;
            max-width: 500px;
            padding: 24px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #e7e9ea;
        }

        .modal-close {
            background: none;
            border: none;
            color: #8899a6;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .modal-close:hover {
            color: #e7e9ea;
        }

        .modal-input {
            width: 100%;
            background: #15202b;
            border: 1px solid #38444d;
            border-radius: 8px;
            padding: 12px 14px;
            color: #e7e9ea;
            font-size: 0.95rem;
            font-family: inherit;
            margin-bottom: 14px;
        }

        .modal-input:focus {
            outline: none;
            border-color: #1da1f2;
        }

        .modal-input::placeholder {
            color: #8899a6;
        }

        .modal-textarea {
            resize: none;
            height: 120px;
        }

        .modal-select {
            width: 100%;
            background: #15202b;
            border: 1px solid #38444d;
            border-radius: 8px;
            padding: 12px 14px;
            color: #e7e9ea;
            font-size: 0.95rem;
            font-family: inherit;
            margin-bottom: 20px;
            cursor: pointer;
        }

        .modal-select:focus {
            outline: none;
            border-color: #1da1f2;
        }

        .modal-submit {
            width: 100%;
            padding: 12px;
            background: #1da1f2;
            border: none;
            border-radius: 9999px;
            color: #fff;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .modal-submit:hover {
            background: #1a91da;
        }

        .modal-submit:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .hidden {
            display: none;
        }

        /* Visual shapes for categories */
        .category-visual svg {
            width: 52px;
            height: 52px;
            stroke: #8899a6;
            stroke-width: 1.5;
            fill: none;
        }

        .category-card:hover .category-visual svg {
            stroke: #1da1f2;
        }

        @media (max-width: 900px) {
            .categories {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 700px) {
            .categories {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 500px) {
            .container {
                padding: 12px;
            }

            .categories {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .category-card {
                padding: 24px 12px;
                min-height: 170px;
                font-size: 1.05rem;
                border-radius: 18px;
                margin-bottom: 8px;
            }

            .category-visual {
                width: 54px;
                height: 54px;
                font-size: 2.2rem;
            }

            .category-visual svg {
                width: 44px;
                height: 44px;
            }

            .category-name {
                font-size: 1.1rem;
                margin-bottom: 6px;
            }

            .category-desc {
                font-size: 0.9rem;
                line-height: 1.5;
                margin-bottom: 2px;
            }

            .plus-btn {
                width: 56px;
                height: 56px;
                font-size: 2.1rem;
                top: 12px;
                right: 12px;
            }

            .modal {
                max-width: 98vw;
                padding: 12px;
            }

            .modal-title {
                font-size: 1.1rem;
            }

            .modal-input, .modal-select, .modal-submit {
                font-size: 1.05rem;
                padding: 14px 10px;
            }

            .modal-textarea {
                height: 80px;
            }

            .modal-submit {
                padding: 14px;
                font-size: 1.1rem;
            }

            .post {
                padding: 12px;
                font-size: 1.05rem;
            }

            .post-headline {
                font-size: 1.05rem;
            }

            .post-content {
                font-size: 1rem;
            }

            .relate-btn {
                padding: 12px 16px;
                font-size: 1.1rem;
            }
        }

        @media (max-width: 700px) {
            #sidebarNav {
                display: none !important;
            }

            #mobileMenuBtn {
                display: block !important;
            }

            .plus-btn {
                top: unset !important;
                bottom: 18px !important;
                right: 18px !important;
                width: 56px !important;
                height: 56px !important;
                font-size: 2.1rem !important;
                box-shadow: 0 6px 16px rgba(29, 161, 242, 0.4) !important;
            }

            header {
                margin-bottom: 10px;
            }

            h1 {
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>

    <button class="plus-btn" onclick="openModal()">+</button>

    <div id="composeModal" class="modal-overlay hidden" onclick="closeModalOnOverlay(event)">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">Create Post</span>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <input type="text" id="modalHeadline" class="modal-input" placeholder="Headline (optional)">
            <textarea id="modalContent" class="modal-input modal-textarea" placeholder="What's on your mind..."></textarea>
            <select id="modalCategory" class="modal-select">
                <option value="" disabled selected>Select a room...</option>
                <option value="daily-thoughts">üí≠ Daily Thoughts</option>
                <option value="addictions">üé∞ Addictions</option>
                <option value="unpopular-opinions">üôä Unpopular Opinions</option>
                <option value="conspiracy">üëÅÔ∏è Conspiracy Theories</option>
                <option value="anger">üí¢ Anger</option>
                <option value="dark-thoughts">üåë Dark Thoughts</option>
                <option value="free-speech">üì¢ Free Speech</option>
                <option value="religious-trauma">‚õ™ Religious Trauma</option>
                <option value="love">üíî Love</option>
                <option value="confessions">üìù Confessions</option>
                <option value="masks">üé≠ Masks & Pretending</option>
                <option value="failure-shame">üòû Failure & Shame</option>
            </select>
            <button id="modalSubmitBtn" class="modal-submit" onclick="submitModalPost()" disabled>Post</button>
        </div>
    </div>

    <div class="main-layout">
        <aside class="sidebar" id="sidebarNav">
            <div class="sidebar-section">
                <a href="#" id="whatsBeenSaidLink" style="color:#1da1f2;font-weight:600;display:block;margin-bottom:18px;">What's been said</a>
                <a href="#" id="allRoomsLink" style="color:#1da1f2;font-weight:600;display:block;margin-bottom:18px;">All Rooms</a>
                <a href="#" id="aboutLink" style="color:#1da1f2;font-weight:600;display:block;">About</a>
            </div>
        </aside>
        <main class="main-feed">
            <header>
                <h1 style="cursor:pointer;" id="homeTitle">Friends<span>&</span>Me</h1>
                <button id="mobileMenuBtn" aria-label="Menu" style="display:none;background:none;border:none;font-size:2rem;color:#1da1f2;line-height:1;cursor:pointer;margin-left:8px;">&#9776;</button>
            </header>
            <nav id="mobileNavMenu" style="display:none;position:fixed;top:56px;right:0;width:70vw;max-width:260px;background:#192734;border-left:1px solid #38444d;box-shadow:-2px 0 12px rgba(0,0,0,0.18);z-index:2000;padding:24px 0 12px 0;">
                <a href="#" id="mobileNavFeed" style="display:block;padding:16px 24px;color:#1da1f2;font-weight:600;text-decoration:none;">What's been said</a>
                <a href="#" id="mobileNavRooms" style="display:block;padding:16px 24px;color:#1da1f2;font-weight:600;text-decoration:none;">All Rooms</a>
                <a href="#" id="mobileNavAbout" style="display:block;padding:16px 24px;color:#1da1f2;font-weight:600;text-decoration:none;">About</a>
            </nav>
            <div id="latestPostContainer"></div>
        </main>
    </div>

    <script>
        // Supabase setup
        const SUPABASE_URL = 'https://bgvmhnqifsjypebavxto.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJndm1obnFpZnNqeXBlYmF2eHRvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1NjE4MzMsImV4cCI6MjA4MTEzNzgzM30.C_wwv8JvyOMBZ_M47DOSSrC5mm3UB6MDHxTvDIm-YWY';
        const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentCategory = null;
        let relatedPosts = JSON.parse(localStorage.getItem('friendsme_related')) || [];
        let relatedComments = JSON.parse(localStorage.getItem('friendsme_comment_related')) || [];

        const ANNOUNCEMENT_TEXT = 'Hello Friends,hope 2026 is treating you well so far.I am the one who built this website and i\'m working on make it avaible on Google play store and apple play store.If you have any features or recommandations to add,say it in the comment section.Thx.';

        const categoryNames = {
            'daily-thoughts': 'daily thoughts',
            'addictions': 'addictions',
            'unpopular-opinions': 'unpopular opinions',
            'conspiracy': 'conspiracy theories',
            'anger': 'anger & hatred',
            'dark-thoughts': 'dark thoughts',
            'free-speech': 'free speech',
            'religious-trauma': 'religious trauma',
            'love': 'love',
            'confessions': 'confessions',
            'masks': 'masks & pretending',
            'failure-shame': 'failure & shame'
        };


        // --- New Layout Logic ---

        // Temporary pinned announcement (always on top of main feed)
        function getPinnedAnnouncementHtml(announcementPost) {
            // If a real post exists with this text, render it so users can like/comment
            if (announcementPost) {
                return `
                    <div style="border-radius:16px;border:1px solid #1da1f2;margin-bottom:12px;padding:6px 0;">
                        <div style="font-size:0.75rem;color:#8899a6;margin:0 16px 4px 16px;display:flex;align-items:center;gap:4px;">
                            <span>üìå</span><span>Message from the creator</span>
                        </div>
                        ${renderSinglePost(announcementPost, true)}
                    </div>
                `;
            }

            // Fallback static card (no comments) if the post doesn't exist yet
            return `
                <div class="post" style="border-color:#1da1f2;">
                    <div class="post-headline" style="display:flex;align-items:center;gap:6px;">
                        <span>üìå</span>
                        <span>Welcome from the creator</span>
                    </div>
                    <div class="post-content" style="margin-top:4px;">
                        Hello Friends,hope 2026 is treating you well so far.I am the one who built this website and i'm working on make it avaible on Google play store and apple play store.If you have any features or recommandations to add,say it in the comment section.Thx.
                    </div>
                </div>
            `;
        }

        // Ensure the announcement exists as a real post so users can comment on it
        async function ensureAnnouncementPostExists() {
            try {
                const { data, error } = await db
                    .from('posts')
                    .select('*')
                    .eq('content', ANNOUNCEMENT_TEXT)
                    .limit(1);

                if (!error && data && data.length) {
                    return data[0];
                }

                const { data: inserted, error: insertError } = await db
                    .from('posts')
                    .insert([{
                        category: 'daily-thoughts',
                        headline: null,
                        content: ANNOUNCEMENT_TEXT,
                        relates: 0
                    }])
                    .select()
                    .single();

                if (insertError) {
                    console.error('Failed to create announcement post', insertError);
                    return null;
                }

                return inserted;
            } catch (e) {
                console.error('Error ensuring announcement post exists', e);
                return null;
            }
        }

        // --- Main Feed: All latest posts with Show More ---
        let feedOffset = 0;
        const FEED_LIMIT = 10;
        async function loadMainFeed(reset = false) {
            if (reset) feedOffset = 0;
            let announcementPost = null;
            if (reset) {
                announcementPost = await ensureAnnouncementPostExists();
            }
            const { data: posts, error } = await db
                .from('posts')
                .select('*')
                .order('created_at', { ascending: false })
                .range(feedOffset, feedOffset + FEED_LIMIT - 1);
            const container = document.getElementById('latestPostContainer');
            if (!announcementPost && posts && posts.length) {
                announcementPost = posts.find(p => p.content === ANNOUNCEMENT_TEXT);
            }
            if (reset) {
                container.innerHTML = getPinnedAnnouncementHtml(announcementPost);
            }
            if (error || !posts) {
                container.innerHTML = '<div class="empty-state"><p>Error loading posts.</p></div>';
                return;
            }
            if (posts.length === 0 && feedOffset === 0) {
                container.innerHTML += '<div class="empty-state"><p>No posts yet. Be the first to share.</p></div>';
                return;
            }

            // Do not show the announcement twice in the list
            const visiblePosts = announcementPost
                ? posts.filter(p => p.id !== announcementPost.id)
                : posts;

            container.innerHTML += visiblePosts.map(post => renderSinglePost(post, true)).join('');
            // Load comment counts for these posts (non-blocking)
            updateCommentCountsForPosts(posts);
            // Show more button
            let showMoreBtn = document.getElementById('showMoreBtn');
            if (!showMoreBtn) {
                showMoreBtn = document.createElement('button');
                showMoreBtn.id = 'showMoreBtn';
                showMoreBtn.textContent = 'Show more';
                showMoreBtn.className = 'modal-submit';
                showMoreBtn.style.margin = '24px auto 0 auto';
                showMoreBtn.style.display = 'block';
                showMoreBtn.onclick = () => { feedOffset += FEED_LIMIT; loadMainFeed(false); };
                container.parentNode.appendChild(showMoreBtn);
            }
            if (posts.length < FEED_LIMIT) showMoreBtn.style.display = 'none';
            else showMoreBtn.style.display = 'block';
        }

        // --- About Page ---
        function showAboutPage() {
            const container = document.getElementById('latestPostContainer');
            container.innerHTML = `
                <div style="text-align:center;margin-top:36px;">
                    <h2 style="margin:18px 0 8px 0;">About Friends&Me</h2>
                    <p style="color:#8899a6;font-size:1.1rem;max-width:420px;margin:0 auto 32px auto;">Friends&Me is a safe, anonymous space to share your thoughts and feelings. No accounts, no judgment. Just real talk. Connect with others through rooms like Daily Thoughts, Confessions, and more.</p>
                </div>
                <div style="max-width:600px;margin:0 auto 32px auto;background:#192734;border:1px solid #38444d;border-radius:16px;padding:28px 18px 18px 18px;">
                    <h3 style="color:#1da1f2;margin-bottom:18px;">The 10 Commandments of Friends&Me</h3>
                    <ol style="text-align:left;color:#e7e9ea;font-size:1.05rem;line-height:1.7;padding-left:22px;">
                        <li>Thou shalt not judge, for everyone‚Äôs got weird stuff in their head.<br><span style='color:#8899a6;font-size:0.98em;'>Ex: ‚ÄúYou confessed to eating 12 tacos alone? Respect.‚Äù</span></li>
                        <li>Thou shalt keep it anonymous‚Äîno names, no shame, just vibes.<br><span style='color:#8899a6;font-size:0.98em;'>Ex: ‚ÄúSigned, NotTellingU99.‚Äù</span></li>
                        <li>Thou shalt not spam, lest ye be banished to the land of unread posts.<br><span style='color:#8899a6;font-size:0.98em;'>Ex: ‚ÄúBuy crypto now!‚Äù (Nope.)</span></li>
                        <li>Thou shalt support, not troll. Hugs &gt; hate.<br><span style='color:#8899a6;font-size:0.98em;'>Ex: ‚ÄúSending virtual hugs, not virtual eye rolls.‚Äù</span></li>
                        <li>Thou shalt use the right room. Don‚Äôt put your love drama in ‚ÄòConspiracy Theories‚Äô (unless it‚Äôs wild).<br><span style='color:#8899a6;font-size:0.98em;'>Ex: ‚ÄúMy ex is a lizard person.‚Äù (Okay, maybe.)</span></li>
                        <li>Thou shalt not dox, stalk, or reveal personal info. This isn‚Äôt detective school.<br><span style='color:#8899a6;font-size:0.98em;'>Ex: ‚ÄúI think I know who you are!‚Äù (No, you don‚Äôt.)</span></li>
                        <li>Thou shalt keep it legal. Cops don‚Äôt vibe here.<br><span style='color:#8899a6;font-size:0.98em;'>Ex: ‚ÄúI robbed a bank.‚Äù (Nope, and also‚Ä¶ what?)</span></li>
                        <li>Thou shalt be real, but not mean. Honesty is cool, cruelty is not.<br><span style='color:#8899a6;font-size:0.98em;'>Ex: ‚ÄúYour post made me think. Thanks!‚Äù (Good.) ‚ÄúYou suck.‚Äù (Not good.)</span></li>
                        <li>Thou shalt not take advice as gospel. Internet wisdom is‚Ä¶ questionable.<br><span style='color:#8899a6;font-size:0.98em;'>Ex: ‚ÄúMy cat told me to invest in socks.‚Äù (Maybe don‚Äôt.)</span></li>
                        <li>Thou shalt have fun, vent, and remember: you‚Äôre not alone in the weirdness.<br><span style='color:#8899a6;font-size:0.98em;'>Ex: ‚ÄúToday I wore my shirt inside out all day. Felt powerful.‚Äù</span></li>
                    </ol>
                </div>
            `;
            let showMoreBtn = document.getElementById('showMoreBtn');
            if (showMoreBtn) showMoreBtn.style.display = 'none';
        }

        // --- All Rooms Grid ---
        function showAllRoomsGrid() {
            const container = document.getElementById('latestPostContainer');
            let html = '<div class="categories" style="margin-top:24px;">';
            const roomInfo = {
                'daily-thoughts': {emoji:'üí≠',desc:"What's running through your mind today"},
                'addictions': {emoji:'üé∞',desc:"Struggling with habits you can't control"},
                'unpopular-opinions': {emoji:'üôä',desc:"Views you're afraid to say out loud"},
                'conspiracy': {emoji:'üëÅÔ∏è',desc:"Question everything you've been told"},
                'anger': {emoji:'üí¢',desc:"Fury that's hard to contain"},
                'dark-thoughts': {emoji:'üåë',desc:"When your mind becomes your enemy"},
                'free-speech': {emoji:'üì¢',desc:"Get it off your chest, no judgement"},
                'religious-trauma': {emoji:'‚õ™',desc:"Faith, doubt, and spiritual wounds"},
                'love': {emoji:'üíî',desc:"Heartbreak, crushes, and everything between"},
                'confessions': {emoji:'üìù',desc:"Say what you can't say anywhere else"},
                'masks': {emoji:'üé≠',desc:"The exhaustion of faking who you are"},
                'failure-shame': {emoji:'üòû',desc:"Career collapse, humiliation, looking stupid"}
            };
            for (const [cat, name] of Object.entries(categoryNames)) {
                html += `<div class="category-card" data-category="${cat}" onclick="openRoom('${cat}')">
                    <div class="category-visual">${roomInfo[cat]?.emoji || ''}</div>
                    <div class="category-name">${name}</div>
                    <div class="category-desc">${roomInfo[cat]?.desc || ''}</div>
                </div>`;
            }
            html += '</div>';
            container.innerHTML = html;
            let showMoreBtn = document.getElementById('showMoreBtn');
            if (showMoreBtn) showMoreBtn.style.display = 'none';
        }

        // --- Sidebar & Mobile Link Handlers ---
        document.addEventListener('DOMContentLoaded', () => {
            // Desktop sidebar
            document.getElementById('whatsBeenSaidLink').onclick = (e) => { e.preventDefault(); loadMainFeed(true); };
            document.getElementById('allRoomsLink').onclick = (e) => { e.preventDefault(); showAllRoomsGrid(); };
            document.getElementById('aboutLink').onclick = (e) => { e.preventDefault(); showAboutPage(); };

            const homeTitle = document.getElementById('homeTitle');
            if (homeTitle) homeTitle.onclick = (e) => { e.preventDefault(); loadMainFeed(true); };

            // Mobile hamburger menu
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const mobileNavMenu = document.getElementById('mobileNavMenu');
            if (mobileMenuBtn && mobileNavMenu) {
                mobileMenuBtn.onclick = function (e) {
                    e.stopPropagation();
                    mobileNavMenu.style.display = mobileNavMenu.style.display === 'block' ? 'none' : 'block';
                };

                document.body.addEventListener('click', function (e) {
                    if (
                        mobileNavMenu.style.display === 'block' &&
                        !mobileNavMenu.contains(e.target) &&
                        e.target !== mobileMenuBtn
                    ) {
                        mobileNavMenu.style.display = 'none';
                    }
                });

                document.getElementById('mobileNavFeed').onclick = (e) => {
                    e.preventDefault();
                    mobileNavMenu.style.display = 'none';
                    loadMainFeed(true);
                };

                document.getElementById('mobileNavRooms').onclick = (e) => {
                    e.preventDefault();
                    mobileNavMenu.style.display = 'none';
                    showAllRoomsGrid();
                };

                document.getElementById('mobileNavAbout').onclick = (e) => {
                    e.preventDefault();
                    mobileNavMenu.style.display = 'none';
                    showAboutPage();
                };
            }

            // Initial load
            loadMainFeed(true);
        });

        // Show single post (used in feed and rooms)
        function renderSinglePost(post, showRoom) {
            const isRelated = relatedPosts.includes(post.id);
            const timeAgo = getTimeAgo(post.created_at);
            const headlineHtml = post.headline ? `<div class="post-headline">${escapeHtml(post.headline)}</div>` : '';
            const roomBadge = showRoom ? `<span class="room-badge" style="background:#22303c;color:#1da1f2;padding:2px 10px;border-radius:8px;font-size:0.92em;margin-right:8px;">${categoryNames[post.category] || post.category}</span>` : '';
            const source = showRoom ? 'feed' : 'room';
            const safeCategory = post.category || '';
            return `
                <div class="post" onclick="openPostThread('${post.id}','${source}','${safeCategory}')">
                    ${headlineHtml}
                    <div class="post-content">${escapeHtml(post.content)}</div>
                    <div class="post-footer">
                        <span class="post-time">${roomBadge}${timeAgo}</span>
                        <button class="relate-btn ${isRelated ? 'related' : ''}" data-post-id="${post.id}" onclick="event.stopPropagation(); toggleRelate('${post.id}')">
                            <span class="heart">${isRelated ? '‚ô•' : '‚ô°'}</span>
                            <span class="relate-count">${post.relates || 0}</span>
                        </button>
                    </div>
                    <div class="post-comments-bar">
                        <button class="comment-toggle" onclick="event.stopPropagation(); openPostThread('${post.id}','${source}','${safeCategory}')">
                            <span>üí¨</span>
                            <span class="comment-count" data-comment-count-for="${post.id}">0</span>
                            <span>comments</span>
                        </button>
                    </div>
                </div>
            `;
        }

        // Open room: show all posts for that room in center, with back to all rooms
        async function openRoom(category) {
            const latestPostContainer = document.getElementById('latestPostContainer');
            latestPostContainer.innerHTML = '<div style="margin-bottom:18px;"><a href="#" id="backToRoomsFromPosts" style="color:#1da1f2;font-weight:600;">‚Üê All Rooms</a></div>';
            latestPostContainer.innerHTML += '<div class="empty-state"><p>loading...</p></div>';
            const { data, error } = await db
                .from('posts')
                .select('*')
                .eq('category', category)
                .order('created_at', { ascending: false });
            if (error) {
                latestPostContainer.innerHTML = '<div style="margin-bottom:18px;"><a href="#" id="backToRoomsFromPosts" style="color:#1da1f2;font-weight:600;">‚Üê All Rooms</a></div>' + '<div class="empty-state"><p>error loading posts</p></div>';
                setTimeout(() => {
                    const backBtn = document.getElementById('backToRoomsFromPosts');
                    if (backBtn) backBtn.onclick = (e) => { e.preventDefault(); showAllRoomsGrid(); };
                }, 0);
                return;
            }
            if (!data || data.length === 0) {
                latestPostContainer.innerHTML = '<div style="margin-bottom:18px;"><a href="#" id="backToRoomsFromPosts" style="color:#1da1f2;font-weight:600;">‚Üê All Rooms</a></div>' + `<div class="empty-state"><p>No posts in this room yet.</p></div>`;
                setTimeout(() => {
                    const backBtn = document.getElementById('backToRoomsFromPosts');
                    if (backBtn) backBtn.onclick = (e) => { e.preventDefault(); showAllRoomsGrid(); };
                }, 0);
                return;
            }
            latestPostContainer.innerHTML = '<div style="margin-bottom:18px;"><a href="#" id="backToRoomsFromPosts" style="color:#1da1f2;font-weight:600;">‚Üê All Rooms</a></div>' + data.map(post => renderSinglePost(post, false)).join('');
            // Load comment counts for posts in this room
            updateCommentCountsForPosts(data);
            setTimeout(() => {
                const backBtn = document.getElementById('backToRoomsFromPosts');
                if (backBtn) backBtn.onclick = (e) => { e.preventDefault(); showAllRoomsGrid(); };
            }, 0);
        }

        // Open a single post thread view (like Twitter: full comments on separate view)
        async function openPostThread(postId, source, category) {
            const container = document.getElementById('latestPostContainer');

            // Hide "Show more" button in thread view so layout isn't broken
            const showMoreBtn = document.getElementById('showMoreBtn');
            if (showMoreBtn) {
                showMoreBtn.style.display = 'none';
            }

            const isRoomView = source === 'room' && category;
            const backLabel = isRoomView ? 'Back to room' : "What's been said";

            container.innerHTML = `
                <div style="margin-bottom:18px;">
                    <a href="#" id="backFromThread" style="color:#1da1f2;font-weight:600;">‚Üê ${backLabel}</a>
                </div>
                <div class="empty-state"><p>Loading post...</p></div>
            `;

            // Load the post
            const { data: post, error: postError } = await db
                .from('posts')
                .select('*')
                .eq('id', postId)
                .single();

            if (postError || !post) {
                container.innerHTML = `
                    <div style="margin-bottom:18px;">
                        <a href="#" id="backFromThread" style="color:#1da1f2;font-weight:600;">‚Üê ${backLabel}</a>
                    </div>
                    <div class="empty-state"><p>Post not found.</p></div>
                `;
                const back = document.getElementById('backFromThread');
                if (back) {
                    back.onclick = (e) => {
                        e.preventDefault();
                        if (isRoomView) {
                            openRoom(category);
                        } else {
                            loadMainFeed(true);
                        }
                    };
                }
                return;
            }

            // Render the post (no inline comments here)
            const postHtml = renderSinglePost(post, source === 'feed');

            // Dedicated comments section for this thread
            const threadHtml = `
                <div style="margin-bottom:18px;">
                    <a href="#" id="backFromThread" style="color:#1da1f2;font-weight:600;">‚Üê ${backLabel}</a>
                </div>
                ${postHtml}
                <div class="comments-section" id="comments-${post.id}" style="margin-top:12px;">
                    <div class="comments-list" id="comments-list-${post.id}">
                        <div class="comment-empty">Loading comments...</div>
                    </div>
                    <div class="comment-form">
                        <textarea
                            id="comment-input-${post.id}"
                            class="comment-input"
                            placeholder="Add a comment..."
                        ></textarea>
                        <button
                            id="comment-submit-${post.id}"
                            class="comment-submit"
                            onclick="submitComment('${post.id}')"
                        >Add comment</button>
                    </div>
                </div>
            `;

            container.innerHTML = threadHtml;

            // Back link behaviour
            const back = document.getElementById('backFromThread');
            if (back) {
                back.onclick = (e) => {
                    e.preventDefault();
                    if (isRoomView) {
                        openRoom(category);
                    } else {
                        loadMainFeed(true);
                    }
                };
            }

            // Load comments into this thread view
            await loadComments(post.id);
        }

        async function toggleRelate(postId) {
            const index = relatedPosts.indexOf(postId);
            const isRelated = index !== -1;

            // Update local state
            if (isRelated) {
                relatedPosts.splice(index, 1);
            } else {
                relatedPosts.push(postId);
            }
            localStorage.setItem('friendsme_related', JSON.stringify(relatedPosts));

            // Update UI for this post's button
            const btn = document.querySelector(`button.relate-btn[data-post-id="${postId}"]`);
            if (btn) {
                const countEl = btn.querySelector('.relate-count');
                const heartEl = btn.querySelector('.heart');
                const current = parseInt(countEl?.textContent || '0', 10) || 0;
                const updated = Math.max(0, current + (isRelated ? -1 : 1));
                countEl.textContent = updated;
                btn.classList.toggle('related', !isRelated);
                if (heartEl) {
                    heartEl.textContent = !isRelated ? '‚ô•' : '‚ô°';
                }
            }

            // Best-effort update to Supabase count (non-blocking)
            try {
                const btn = document.querySelector(`button.relate-btn[data-post-id="${postId}"]`);
                const countEl = btn?.querySelector('.relate-count');
                const current = parseInt(countEl?.textContent || '0', 10) || 0;
                await db
                    .from('posts')
                    .update({ relates: current })
                    .eq('id', postId);
            } catch (e) {
                console.error('Failed to update relates count', e);
            }
        }

        // --- Comments helpers ---
        async function updateCommentCountsForPosts(posts) {
            if (!posts || posts.length === 0) return;
            for (const post of posts) {
                try {
                    const { count, error } = await db
                        .from('comments')
                        .select('id', { count: 'exact', head: true })
                        .eq('post_id', post.id);
                    if (!error && typeof count === 'number') {
                        setCommentCount(post.id, count);
                    }
                } catch (e) {
                    console.error('Error loading comment count', e);
                }
            }
        }

        function setCommentCount(postId, count) {
            const el = document.querySelector(`.comment-count[data-comment-count-for="${postId}"]`);
            if (el) {
                el.textContent = count;
            }
        }

        async function loadComments(postId) {
            const listEl = document.getElementById(`comments-list-${postId}`);
            if (!listEl) return;

            listEl.innerHTML = '<div class="comment-empty">Loading comments...</div>';

            const { data, error } = await db
                .from('comments')
                .select('*')
                .eq('post_id', postId)
                .order('created_at', { ascending: true });

            if (error) {
                console.error('Error loading comments', error);
                listEl.innerHTML = '<div class="comment-empty">Error loading comments.</div>';
                return;
            }

            if (!data || data.length === 0) {
                listEl.innerHTML = '<div class="comment-empty">No comments yet. Be the first to respond.</div>';
                setCommentCount(postId, 0);
                return;
            }

            listEl.innerHTML = data.map(c => {
                const isLiked = relatedComments.includes(c.id);
                const likes = c.relates || 0;
                return `
                <div class="comment-item">
                    <div class="comment-content">${escapeHtml(c.content)}</div>
                    <div class="comment-footer">
                        <span class="comment-meta">${getTimeAgo(c.created_at)}</span>
                        <button class="comment-like-btn ${isLiked ? 'liked' : ''}" data-comment-id="${c.id}" onclick="toggleCommentRelate('${c.id}')">
                            <span>${isLiked ? '‚ô•' : '‚ô°'}</span>
                            <span class="comment-like-count">${likes}</span>
                        </button>
                    </div>
                </div>
                `;
            }).join('');

            setCommentCount(postId, data.length);
        }

        async function submitComment(postId) {
            const input = document.getElementById(`comment-input-${postId}`);
            const btn = document.getElementById(`comment-submit-${postId}`);
            if (!input || !btn) return;

            const content = input.value.trim();
            if (!content) return;

            btn.disabled = true;
            const originalText = btn.textContent;
            btn.textContent = 'Posting...';

            const { error } = await db
                .from('comments')
                .insert([{ post_id: postId, content }]);

            if (error) {
                console.error('Error adding comment:', error);
                alert('Failed to add comment. Please try again.');
                btn.disabled = false;
                btn.textContent = originalText;
                return;
            }

            input.value = '';
            await loadComments(postId);
            btn.disabled = false;
            btn.textContent = originalText;
        }

        async function toggleCommentRelate(commentId) {
            const index = relatedComments.indexOf(commentId);
            const isLiked = index !== -1;

            // Update local state
            if (isLiked) {
                relatedComments.splice(index, 1);
            } else {
                relatedComments.push(commentId);
            }
            localStorage.setItem('friendsme_comment_related', JSON.stringify(relatedComments));

            // Update UI
            const btn = document.querySelector(`button.comment-like-btn[data-comment-id="${commentId}"]`);
            if (btn) {
                const countEl = btn.querySelector('.comment-like-count');
                const heartEl = btn.querySelector('span');
                const current = parseInt(countEl?.textContent || '0', 10) || 0;
                const updated = Math.max(0, current + (isLiked ? -1 : 1));
                if (countEl) countEl.textContent = updated;
                btn.classList.toggle('liked', !isLiked);
                if (heartEl) heartEl.textContent = !isLiked ? '‚ô•' : '‚ô°';
            }

            // Best-effort update to Supabase count
            try {
                const btnEl = document.querySelector(`button.comment-like-btn[data-comment-id="${commentId}"]`);
                const countEl = btnEl?.querySelector('.comment-like-count');
                const current = parseInt(countEl?.textContent || '0', 10) || 0;
                await db
                    .from('comments')
                    .update({ relates: current })
                    .eq('id', commentId);
            } catch (e) {
                console.error('Failed to update comment like count', e);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getTimeAgo(timestamp) {
            const seconds = Math.floor((new Date() - new Date(timestamp)) / 1000);
            
            if (seconds < 60) return 'just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
            if (seconds < 604800) return Math.floor(seconds / 86400) + 'd ago';
            return new Date(timestamp).toLocaleDateString();
        }

        // Modal functions
        function openModal() {
            document.getElementById('composeModal').classList.remove('hidden');
            document.getElementById('modalContent').focus();
        }

        function closeModal() {
            document.getElementById('composeModal').classList.add('hidden');
            document.getElementById('modalHeadline').value = '';
            document.getElementById('modalContent').value = '';
            document.getElementById('modalCategory').value = '';
            document.getElementById('modalSubmitBtn').disabled = true;
        }

        function closeModalOnOverlay(event) {
            if (event.target.classList.contains('modal-overlay')) {
                closeModal();
            }
        }

        function checkModalForm() {
            const content = document.getElementById('modalContent').value.trim();
            const category = document.getElementById('modalCategory').value;
            document.getElementById('modalSubmitBtn').disabled = !content || !category;
        }

        async function submitModalPost() {
            const headline = document.getElementById('modalHeadline').value.trim();
            const content = document.getElementById('modalContent').value.trim();
            const category = document.getElementById('modalCategory').value;

            if (!content || !category) return;

            // Disable button while posting
            document.getElementById('modalSubmitBtn').disabled = true;
            document.getElementById('modalSubmitBtn').textContent = 'Posting...';

            const { data, error } = await db
                .from('posts')
                .insert([{
                    category: category,
                    headline: headline || null,
                    content: content,
                    relates: 0
                }])
                .select();

            if (error) {
                console.error('Error posting:', error);
                alert('Failed to post. Please try again.');
                document.getElementById('modalSubmitBtn').disabled = false;
                document.getElementById('modalSubmitBtn').textContent = 'Post';
                return;
            }

            closeModal();
            document.getElementById('modalSubmitBtn').textContent = 'Post';

            // Refresh main feed so the new post is visible right away
            loadMainFeed(true);

        }

        document.getElementById('modalContent').addEventListener('input', checkModalForm);
        document.getElementById('modalCategory').addEventListener('change', checkModalForm);
    </script>
</body>
</html>
